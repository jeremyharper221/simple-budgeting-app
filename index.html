<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Finance Planner with Goals</title>
    <!-- We are using Inter for a clean, modern look. -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* General body and typography styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 24px;
        }

        /* Main app container */
        .app-container {
            max-width: 960px;
            margin: 0 auto;
            background-color: #fff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 16px;
            padding: 32px;
        }
        
        /* Month navigation header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 8px; /* Added gap for new button */
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        /* Ready to assign section */
        .ready-to-assign {
            background-color: #d1fae5;
            padding: 16px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .ready-to-assign h2 {
            font-size: 18px;
            font-weight: 600;
            color: #065f46;
            margin: 0;
        }

        .ready-to-assign .amount {
            font-size: 24px;
            font-weight: 700;
            color: #047857;
            margin: 0;
        }

        /* Button styles */
        button {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        .btn-gray {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .btn-gray:hover {
            background-color: #d1d5db;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .btn-green {
            background-color: #10b981;
            color: #fff;
        }
        .btn-green:hover {
            background-color: #059669;
        }

        .btn-red {
            background-color: #ef4444;
            color: #fff;
        }
        .btn-red:hover {
            background-color: #dc2626;
        }
        
        .btn-secondary {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .btn-secondary.active {
            background-color: #4f46e5;
            color: #fff;
        }
        
        /* Group of buttons */
        .btn-group {
            display: flex;
            gap: 8px;
        }

        /* Form/input styles */
        .form-section {
            padding: 24px;
            background-color: #f9fafb;
            border-radius: 8px;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            margin-top: 32px;
        }
        
        .form-section h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .form-section .input-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .form-section input, .form-section select, .form-section textarea {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            flex-grow: 1;
        }
        
        .form-section textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Budget and Debt table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }
        
        .data-table thead tr {
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Section Header styles */
        .section-header {
             display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .section-header h2 {
            margin: 0;
        }

        /* Reports section specific styles */
        .reports-section, .historical-data-section {
            display: none; /* Initially hidden */
        }
        .reports-grid {
            display: grid;
            gap: 32px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        .chart-card {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .chart-card h3 {
            margin-top: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        /* Historical data section styles */
        .historical-data-section {
            margin-top: 24px;
        }
        .historical-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .historical-header h2 {
            margin: 0;
        }
        
        /* Modals and overlays */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
        }
        
        .modal-header h3 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 8px 0;
        }

        .modal-header p {
            font-size: 14px;
            color: #6b7280;
            margin: 0 0 16px 0;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .modal-footer button {
            margin-left: 8px;
        }
        
        /* New loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .loading-overlay p {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            text-align: center;
        }

        hr {
            margin: 40px 0;
            border: none;
            border-top: 1px dashed #e5e7eb;
        }
    </style>
</head>
<body>
    <!-- Main loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <p>Please select a file to store your budget data.</p>
        <p>This app needs to access a local file on your computer to save your data.</p>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
    <button id="selectFileBtn" class="btn-primary">Select Existing Data File</button>
    <button id="createFileBtn" class="btn-green">Create New Data File</button>
</div>

    </div>

    <div class="app-container" style="display: none;">
        <!-- Month Navigation -->
        <div class="header">
            <button id="prevMonthBtn" class="btn-gray">&lt;</button>
            <h1 id="monthHeader"></h1>
            <div class="btn-group">
                <button id="copyCategoriesBtn" class="btn-secondary">Copy Categories</button>
                <button id="nextMonthBtn" class="btn-gray">&gt;</button>
            </div>
        </div>
        
        <!-- Toggle Buttons for Views -->
        <div class="view-toggles" style="display: flex; gap: 8px; margin-bottom: 24px;">
            <button id="budgetViewBtn" class="btn-secondary active">Budget</button>
            <button id="reportsViewBtn" class="btn-secondary">Reports</button>
            <button id="historicalDataBtn" class="btn-secondary">Historical Data</button>
        </div>


        <!-- Budget View Section -->
        <div id="budgetView" class="view-section">
            <!-- Ready to Assign Section -->
            <div class="ready-to-assign">
                <div>
                    <h2>Ready to Assign</h2>
                    <p id="readyToAssignAmount" class="amount"></p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="addTransactionBtn" class="btn-green">Add Transaction</button>
                    <button id="addBulkTransactionBtn" class="btn-gray">Add Bulk</button>
                </div>
            </div>
    
            <!-- Budget Table -->
            <div class="budget-section">
                <h2 style="margin-top: 0;">Budget Categories</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Assigned</th>
                                <th>Activity</th>
                                <th>Available</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="budgetTableBody">
                            <!-- Dynamic rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
    
            <!-- Add New Category Form -->
            <div class="form-section">
                <h2>Add a New Category</h2>
                <div class="input-group">
                    <input type="text" id="newCategoryName" placeholder="Category Name">
                    <input type="text" id="newParentCategory" placeholder="Parent Category (Optional)">
                    <button id="addCategoryBtn" class="btn-primary">Add Category</button>
                </div>
            </div>
    
            <hr>
    
            <!-- Goals Section -->
            <div class="goals-section">
                <div class="section-header">
                    <h2>Financial Goals</h2>
                    <button id="addGoalBtn" class="btn-primary">Add Goal</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Due Date</th>
                                <th>Total Amount</th>
                                <th>Monthly Contribution</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="goalsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <hr>

            <!-- Debt Tracker Section -->
            <div class="debt-section">
                <div class="section-header">
                    <h2>Debt Tracker</h2>
                    <div class="btn-group">
                        <button id="debtSnowballBtn" class="btn-secondary active">Snowball</button>
                        <button id="debtAvalancheBtn" class="btn-secondary">Avalanche</button>
                        <button id="addDebtBtn" class="btn-primary">Add Debt</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Balance</th>
                                <th>Interest Rate</th>
                                <th>Min. Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="debtTableBody">
                            <!-- Dynamic rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports View Section -->
        <div id="reportsView" class="view-section reports-section">
            <div class="reports-grid">
                <!-- Expenses by Category -->
                <div class="chart-card">
                    <h3>Expenses by Category</h3>
                    <canvas id="expensesByCategoryChart"></canvas>
                </div>

                <!-- Debt Progress -->
                <div class="chart-card">
                    <h3>Debt Progress</h3>
                    <canvas id="debtProgressChart"></canvas>
                </div>

                <!-- Budget vs. Actual Spending -->
                <div class="chart-card">
                    <h3>Budget vs. Actual Spending</h3>
                    <canvas id="budgetVsActualChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Historical Data View Section -->
        <div id="historicalDataView" class="view-section historical-data-section">
            <div class="historical-header">
                <h2>Historical Transactions</h2>
                <div style="display: flex; gap: 8px;">
                    <button id="exportDataBtn" class="btn-primary">Export to CSV</button>
                    <button id="changeFileBtn" class="btn-gray">Change Data File</button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Parent Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historicalTableBody">
                        <!-- Historical data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>


    </div>

    <!-- Modals -->
    
    <!-- Add Goal Modal -->
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Set a New Financial Goal</h3>
                <p>Define your goal, and we'll help you budget for it monthly.</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <input type="text" id="goalNameInput" placeholder="Goal Name (e.g., Vacation Fund)">
                <textarea id="goalDescriptionInput" placeholder="Description (optional)" style="resize: vertical; min-height: 80px;"></textarea>
                <input type="date" id="goalDueDateInput">
                <input type="number" id="goalAmountInput" placeholder="Total Amount Needed">
                <button id="saveGoalBtn" class="btn-primary">Save Goal</button>
            </div>
            <div class="modal-footer">
                <button id="closeGoalModalBtn" class="btn-gray">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Assign Funds Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Funds</h3>
                <p>You have <span id="assignAvailable"></span> available to assign.</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <input type="number" id="assignAmountInput" placeholder="Amount">
                <select id="assignMonthSelect"></select>
                <button id="assignFundsBtn" class="btn-primary">Assign</button>
            </div>
            <div class="modal-footer">
                <button id="closeAssignModalBtn" class="btn-gray">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Add Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Transaction</h3>
                <p>Record an expense or income.</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <input type="number" id="transactionAmountInput" placeholder="Amount">
                <select id="transactionTypeSelect">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
                <input type="date" id="transactionDateInput" value="">
                <input type="text" id="transactionDescriptionInput" placeholder="Description">
                <select id="transactionCategorySelect">
                    <option value="">Select a Category</option>
                </select>
                <button id="recordTransactionBtn" class="btn-primary">Record Transaction</button>
            </div>
            <div class="modal-footer">
                <button id="closeTransactionModalBtn" class="btn-gray">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Historical Transaction Modal -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Transaction</h3>
                <p>Modify the details of this historical transaction.</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <input type="date" id="editTransactionDateInput" value="">
                <input type="number" id="editTransactionAmountInput" placeholder="Amount">
                <select id="editTransactionTypeSelect">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
                <input type="text" id="editTransactionDescriptionInput" placeholder="Description">
                <select id="editTransactionCategorySelect">
                    <option value="">Select a Category</option>
                </select>
            </div>
            <div class="modal-footer">
                <button id="closeEditTransactionModalBtn" class="btn-gray">Cancel</button>
                <button id="saveEditedTransactionBtn" class="btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Transactions Modal -->
    <div id="bulkTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Transactions in Bulk</h3>
                <p>Enter transactions, one per line, in the format: <b>date, amount, category, description, type (expense/income)</b>.<br>Example: 2024-05-15, 25.50, Groceries, Dinner, expense</p>
            </div>
            <textarea id="bulkTransactionsTextarea" placeholder="Enter bulk transactions here..."></textarea>
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 12px;">
                <button id="addBulkTransactionsBtnModal" class="btn-primary">Add Bulk Transactions</button>
            </div>
            <div class="modal-footer">
                <button id="closeBulkTransactionModalBtn" class="btn-gray">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Debt Modal -->
    <div id="debtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Debt</h3>
                <p>Enter details for a new debt.</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <input type="text" id="debtNameInput" placeholder="Debt Name">
                <input type="number" id="debtOriginalBalanceInput" placeholder="Original Balance">
                <input type="number" id="debtCurrentBalanceInput" placeholder="Current Balance">
                <input type="number" id="debtInterestRateInput" placeholder="Interest Rate (%)">
                <input type="number" id="debtMinPaymentInput" placeholder="Minimum Payment">
                <button id="addDebtConfirmBtn" class="btn-primary">Add Debt</button>
            </div>
            <div class="modal-footer">
                <button id="closeDebtModalBtn" class="btn-gray">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Record Payment</h3>
                <p>Make a payment towards <b id="paymentDebtName"></b>.</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <input type="number" id="paymentAmountInput" placeholder="Payment Amount">
                <p>Available for payment: <b id="paymentAvailableFunds"></b></p>
                <button id="recordPaymentConfirmBtn" class="btn-primary">Record Payment</button>
            </div>
            <div class="modal-footer">
                <button id="closePaymentModalBtn" class="btn-gray">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Duplicate Transaction Confirmation Modal -->
    <div id="duplicateConfirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Potential Duplicate Transaction</h3>
                <p>This transaction appears to be a duplicate of an existing record. Do you want to add it anyway?</p>
            </div>
            <p><b>Date:</b> <span id="duplicateDate"></span></p>
            <p><b>Amount:</b> <span id="duplicateAmount"></span></p>
            <p><b>Description:</b> <span id="duplicateDescription"></span></p>
            <div class="modal-footer">
                <button id="addDuplicateAnywayBtn" class="btn-primary">Add Anyway</button>
                <button id="skipDuplicateBtn" class="btn-gray">Skip</button>
            </div>
        </div>
    </div>
    
    <!-- ERROR Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: #dc2626;">Error!</h3>
                <p id="errorMessage" style="color: #6b7280;"></p>
            </div>
            <div class="modal-footer">
                <button id="closeErrorModalBtn" class="btn-gray">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Date-fns functions for easy date manipulation
        import { format, parseISO, addMonths, subMonths, differenceInCalendarMonths, startOfMonth } from "https://cdn.skypack.dev/date-fns";
        import { v4 as uuidv4 } from "https://jspm.dev/uuid";

        // --- GLOBAL VARIABLES AND STATE ---
        let budgets = {};
        let debtList = [];
        let goals = []; // NEW: For storing financial goals
        let currentMonth = format(new Date(), 'yyyy-MM');
        let readyToAssign = 0;
        let debtViewMethod = 'snowball'; // 'snowball' or 'avalanche'
        let selectedDebtId = null; // Used for recording payments
        let editingHistoricalTransactionId = null; // Used for editing transactions
        
        // --- LOCAL FILE STORAGE FUNCTIONALITY ---
        let fileHandle;

         // Use a more modern promise-based wrapper for IndexedDB
        async function getDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('budget-app-db', 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('handles')) {
                        db.createObjectStore('handles');
                    }
                };
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        async function saveFileHandle(handle) {
            try {
                const db = await getDb();
                const tx = db.transaction('handles', 'readwrite');
                const store = tx.objectStore('handles');
                await store.put(handle, 'budgetFile');
                console.log('File handle saved to IndexedDB.');
            } catch (error) {
                console.error('Error saving file handle:', error);
                showErrorModal('Could not save file reference. Your browser may be in private mode.');
            }
        }

        async function getFileHandleFromDB() {
            try {
                const db = await getDb();
                const tx = db.transaction('handles', 'readonly');
                const store = tx.objectStore('handles');
                const handle = await new Promise((resolve, reject) => {
                    const request = store.get('budgetFile');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                return handle;
            } catch (error) {
                console.error('Error getting file handle from DB:', error);
                return null;
            }
        }

        async function chooseNewDataFile() {
            try {
                fileHandle = await window.showSaveFilePicker({
                    suggestedName: 'budgetData.json',
                    types: [{
                        description: 'JSON Files',
                        accept: {
                            'application/json': ['.json']
                        }
                    }],
                });
                await saveFileHandle(fileHandle);
                // Write initial empty data structure
                const initialData = { monthlyBudgets: {}, debtList: [], goals: [], readyToAssign: 0 };
                await writeFile(initialData);
                return initialData;
            } catch (error) {
                // User cancelled the file selection or an error occurred.
                showErrorModal("File selection was cancelled or an error occurred. The app will run without a persistent data file until you select one.");
                console.error("File selection error:", error);
                return { monthlyBudgets: {}, debtList: [], goals: [], readyToAssign: 0 };
            }
        }

        async function readFile() {
            if (!fileHandle) {
                // No file selected, return an empty data structure.
                return { monthlyBudgets: {}, debtList: [], goals: [], readyToAssign: 0 };
            }
            try {
                const file = await fileHandle.getFile();
                const contents = await file.text();
                return JSON.parse(contents || '{}');
            } catch (error) {
                showErrorModal("Error reading data file. It may be corrupted or not a valid JSON file. Please try selecting a different file.");
                console.error("Error parsing JSON:", error);
                return { monthlyBudgets: {}, debtList: [], goals: [], readyToAssign: 0 };
            }
        }

        async function writeFile(data) {
            if (!fileHandle) {
                showErrorModal("No data file selected. Please select a file to save your changes.");
                return;
            }
            try {
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(data, null, 2));
                await writable.close();
            } catch (error) {
                // Handle specific user-facing errors
                if (error.name === 'NotAllowedError') {
                    showErrorModal("Permission to write to the file was denied. Please select a new file.");
                    fileHandle = null; // Clear the handle so they must re-select
                } else {
                    showErrorModal("Could not save data to file. Please ensure the file is not locked or deleted.");
                }
                console.error("Error writing to file:", error);
            }
        }

        const saveDataToFile = async () => {
            const dataToSave = {
                monthlyBudgets: budgets,
                debtList: debtList,
                goals: goals, // NEW: Save goals
                readyToAssign: readyToAssign,
            };
            await writeFile(dataToSave);
            console.log("Data saved to local file.");
        };

        // --- CHART.JS INSTANCES ---
        let expensesByCategoryChart;
        let debtProgressChart;
        let budgetVsActualChart;

        // --- DOM ELEMENT REFERENCES ---
        const monthHeader = document.getElementById('monthHeader');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const readyToAssignAmount = document.getElementById('readyToAssignAmount');
        const budgetTableBody = document.getElementById('budgetTableBody');
        const debtTableBody = document.getElementById('debtTableBody');
        const goalsTableBody = document.getElementById('goalsTableBody'); // NEW
        const historicalTableBody = document.getElementById('historicalTableBody');
        const newCategoryNameInput = document.getElementById('newCategoryName');
        const newParentCategoryInput = document.getElementById('newParentCategory');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const addTransactionBtn = document.getElementById('addTransactionBtn');
        const addBulkTransactionBtn = document.getElementById('addBulkTransactionBtn');
        const addDebtBtn = document.getElementById('addDebtBtn');
        const addGoalBtn = document.getElementById('addGoalBtn'); // NEW
        const debtSnowballBtn = document.getElementById('debtSnowballBtn');
        const debtAvalancheBtn = document.getElementById('debtAvalancheBtn');
        const budgetViewBtn = document.getElementById('budgetViewBtn');
        const reportsViewBtn = document.getElementById('reportsViewBtn');
        const historicalDataBtn = document.getElementById('historicalDataBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const changeFileBtn = document.getElementById('changeFileBtn');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const appContainer = document.querySelector('.app-container');
        const copyCategoriesBtn = document.getElementById('copyCategoriesBtn');

        // Modals and their elements
        const goalModal = document.getElementById('goalModal'); // NEW
        const goalNameInput = document.getElementById('goalNameInput'); // NEW
        const goalDescriptionInput = document.getElementById('goalDescriptionInput'); // NEW
        const goalDueDateInput = document.getElementById('goalDueDateInput'); // NEW
        const goalAmountInput = document.getElementById('goalAmountInput'); // NEW
        const saveGoalBtn = document.getElementById('saveGoalBtn'); // NEW
        const closeGoalModalBtn = document.getElementById('closeGoalModalBtn'); // NEW

        const assignModal = document.getElementById('assignModal');
        const assignAmountInput = document.getElementById('assignAmountInput');
        const assignMonthSelect = document.getElementById('assignMonthSelect');
        const assignFundsBtn = document.getElementById('assignFundsBtn');
        const closeAssignModalBtn = document.getElementById('closeAssignModalBtn');
        const assignAvailable = document.getElementById('assignAvailable');

        const transactionModal = document.getElementById('transactionModal');
        const transactionAmountInput = document.getElementById('transactionAmountInput');
        const transactionTypeSelect = document.getElementById('transactionTypeSelect');
        const transactionDateInput = document.getElementById('transactionDateInput');
        const transactionDescriptionInput = document.getElementById('transactionDescriptionInput');
        const transactionCategorySelect = document.getElementById('transactionCategorySelect');
        const recordTransactionBtn = document.getElementById('recordTransactionBtn');
        const closeTransactionModalBtn = document.getElementById('closeTransactionModalBtn');
        
        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionDateInput = document.getElementById('editTransactionDateInput');
        const editTransactionAmountInput = document.getElementById('editTransactionAmountInput');
        const editTransactionTypeSelect = document.getElementById('editTransactionTypeSelect');
        const editTransactionDescriptionInput = document.getElementById('editTransactionDescriptionInput');
        const editTransactionCategorySelect = document.getElementById('editTransactionCategorySelect');
        const closeEditTransactionModalBtn = document.getElementById('closeEditTransactionModalBtn');
        const saveEditedTransactionBtn = document.getElementById('saveEditedTransactionBtn');

        const bulkTransactionModal = document.getElementById('bulkTransactionModal');
        const bulkTransactionsTextarea = document.getElementById('bulkTransactionsTextarea');
        const addBulkTransactionsBtnModal = document.getElementById('addBulkTransactionsBtnModal');
        const closeBulkTransactionModalBtn = document.getElementById('closeBulkTransactionModalBtn');

        const debtModal = document.getElementById('debtModal');
        const debtNameInput = document.getElementById('debtNameInput');
        const debtOriginalBalanceInput = document.getElementById('debtOriginalBalanceInput');
        const debtCurrentBalanceInput = document.getElementById('debtCurrentBalanceInput');
        const debtInterestRateInput = document.getElementById('debtInterestRateInput');
        const debtMinPaymentInput = document.getElementById('debtMinPaymentInput');
        const addDebtConfirmBtn = document.getElementById('addDebtConfirmBtn');
        const closeDebtModalBtn = document.getElementById('closeDebtModalBtn');

        const paymentModal = document.getElementById('paymentModal');
        const paymentDebtName = document.getElementById('paymentDebtName');
        const paymentAmountInput = document.getElementById('paymentAmountInput');
        const paymentAvailableFunds = document.getElementById('paymentAvailableFunds');
        const recordPaymentConfirmBtn = document.getElementById('recordPaymentConfirmBtn');
        const closePaymentModalBtn = document.getElementById('closePaymentModalBtn');
        
        const duplicateConfirmationModal = document.getElementById('duplicateConfirmationModal');
        const duplicateDate = document.getElementById('duplicateDate');
        const duplicateAmount = document.getElementById('duplicateAmount');
        const duplicateDescription = document.getElementById('duplicateDescription');
        const addDuplicateAnywayBtn = document.getElementById('addDuplicateAnywayBtn');
        const skipDuplicateBtn = document.getElementById('skipDuplicateBtn');

        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeErrorModalBtn = document.getElementById('closeErrorModalBtn');

        // --- UTILITY FUNCTIONS ---
        function formatCurrency(amount) {
            return `$${parseFloat(amount).toFixed(2)}`;
        }

        function getMonthData(month) {
            if (!budgets[month]) {
                budgets[month] = {
                    categories: {},
                    transactions: [],
                };
            }
            return budgets[month];
        }

        function calculateActivity(month, categoryName) {
            const monthData = getMonthData(month);
            return monthData.transactions
                .filter(t => t.category === categoryName && t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
        }

        function calculateCategoryAvailable(month, categoryName) {
            const monthData = getMonthData(month);
            const assigned = monthData.categories[categoryName]?.assigned || 0;
            const activity = calculateActivity(month, categoryName);
            return assigned - activity;
        }

        function showModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        function hideModal(modalElement) {
            modalElement.style.display = 'none';
        }
        
        function showErrorModal(message) {
            errorMessage.textContent = message;
            showModal(errorModal);
        }

        // --- RENDERING FUNCTIONS ---
        function renderUI() {
            monthHeader.textContent = format(parseISO(currentMonth + '-01'), 'MMMM yyyy');
            readyToAssignAmount.textContent = formatCurrency(readyToAssign);

            const monthData = getMonthData(currentMonth);
            renderBudgetTable(monthData);
            renderGoalsTable();
            renderDebtTable();
            renderHistoricalDataTable();
        }

        function renderBudgetTable(monthData) {
            budgetTableBody.innerHTML = '';
            const allCategories = new Set(Object.keys(monthData.categories));
            for (const monthKey in budgets) {
                for (const catKey in budgets[monthKey].categories) {
                    allCategories.add(catKey);
                }
            }
            const sortedCategories = Array.from(allCategories).sort();

            sortedCategories.forEach(categoryName => {
                const category = monthData.categories[categoryName] || { assigned: 0, parentCategory: '' };
                const activity = calculateActivity(currentMonth, categoryName);
                const available = calculateCategoryAvailable(currentMonth, categoryName);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${categoryName} <br><small style="color: #6b7280;">${category.parentCategory || ''}</small></td>
                    <td>${formatCurrency(category.assigned)}</td>
                    <td>${formatCurrency(activity)}</td>
                    <td style="color: ${available >= 0 ? '#10b981' : '#ef4444'};">${formatCurrency(available)}</td>
                    <td>
                        <button class="btn-primary" onclick="handleAssignFunds('${categoryName}')">Assign</button>
                        <button class="btn-secondary" onclick="handleQuickBudget('${categoryName}')">Quick Budget</button>
                    </td>
                `;
                budgetTableBody.appendChild(row);
            });
        }
        
        function renderGoalsTable() {
            goalsTableBody.innerHTML = '';
            
            goals.forEach(goal => {
                let totalAssigned = 0;
                for (const monthKey in budgets) {
                    if (budgets[monthKey].categories[goal.name]) {
                        totalAssigned += budgets[monthKey].categories[goal.name].assigned || 0;
                    }
                }
                const progress = goal.totalAmount > 0 ? (totalAssigned / goal.totalAmount) * 100 : 0;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${goal.name}<br><small style="color: #6b7280;">${goal.description || ''}</small></td>
                    <td>${format(parseISO(goal.dueDate), 'MMM yyyy')}</td>
                    <td>${formatCurrency(goal.totalAmount)}</td>
                    <td>${formatCurrency(goal.monthlyContribution)}</td>
                    <td>
                        <div style="width: 100%; background-color: #e5e7eb; border-radius: 9999px;">
                            <div style="width: ${progress.toFixed(2)}%; background-color: #10b981; color: white; text-align: center; border-radius: 9999px; padding: 2px 0;">
                                ${progress.toFixed(0)}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <button class="btn-red" onclick="handleDeleteGoal('${goal.id}')">Delete</button>
                    </td>
                `;
                goalsTableBody.appendChild(row);
            });
        }

        function renderDebtTable() {
            debtTableBody.innerHTML = '';

            const sortedDebtList = [...debtList];

            if (debtViewMethod === 'snowball') {
                sortedDebtList.sort((a, b) => a.currentBalance - b.currentBalance);
            } else if (debtViewMethod === 'avalanche') {
                sortedDebtList.sort((a, b) => b.interestRate - a.interestRate);
            }

            sortedDebtList.forEach(debt => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${debt.name}</td>
                    <td>${formatCurrency(debt.currentBalance)}</td>
                    <td>${debt.interestRate}%</td>
                    <td>${formatCurrency(debt.minPayment)}</td>
                    <td>
                        <button class="btn-primary" onclick="handleRecordPayment('${debt.id}')">Pay</button>
                        <button class="btn-red" onclick="handleDeleteDebt('${debt.id}')">Delete</button>
                    </td>
                `;
                debtTableBody.appendChild(row);
            });
        }
        
        function renderHistoricalDataTable() {
            historicalTableBody.innerHTML = '';
            
            let allTransactions = [];
            for (const monthKey in budgets) {
                const monthData = budgets[monthKey];
                const monthTransactions = monthData.transactions.map(t => ({
                    ...t,
                    month: monthKey,
                    categoryParent: monthData.categories[t.category]?.parentCategory || ''
                }));
                allTransactions.push(...monthTransactions);
            }
            
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            allTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                const amountColor = transaction.type === 'income' ? '#10b981' : '#ef4444';
                const formattedDate = format(parseISO(transaction.date), 'MM-dd-yyyy');
                
                row.innerHTML = `
                    <td>${transaction.month}</td>
                    <td>${formattedDate}</td>
                    <td>${transaction.category}</td>
                    <td>${transaction.categoryParent}</td>
                    <td>${transaction.description}</td>
                    <td style="color: ${amountColor};">${formatCurrency(transaction.type === 'expense' ? -transaction.amount : transaction.amount)}</td>
                    <td>
                        <button class="btn-primary" onclick="handleEditTransaction('${transaction.id}')">Edit</button>
                        <button class="btn-red" onclick="handleDeleteTransaction('${transaction.id}', '${transaction.month}')">Delete</button>
                    </td>
                `;
                historicalTableBody.appendChild(row);
            });
        }
        
        function renderCharts() {
            // Expenses by Category Chart
            if (expensesByCategoryChart) { expensesByCategoryChart.destroy(); }
            const expensesByCatCanvas = document.getElementById('expensesByCategoryChart');
            if (expensesByCatCanvas) {
                const expenses = getMonthData(currentMonth).transactions
                    .filter(t => t.type === 'expense')
                    .reduce((acc, t) => {
                        acc[t.category] = (acc[t.category] || 0) + t.amount;
                        return acc;
                    }, {});

                expensesByCategoryChart = new Chart(expensesByCatCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(expenses),
                        datasets: [{
                            data: Object.values(expenses),
                            backgroundColor: [
                                '#4f46e5', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                                '#8b5cf6', '#ec4899', '#22c55e', '#f97316', '#a855f7'
                            ],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: `Expenses for ${format(parseISO(currentMonth + '-01'), 'MMMM yyyy')}`
                            }
                        }
                    }
                });
            }

            // Debt Progress Chart
            if (debtProgressChart) { debtProgressChart.destroy(); }
            const debtProgressCanvas = document.getElementById('debtProgressChart');
            if (debtProgressCanvas) {
                const debtNames = debtList.map(d => d.name);
                const debtBalances = debtList.map(d => d.currentBalance);
                
                debtProgressChart = new Chart(debtProgressCanvas, {
                    type: 'bar',
                    data: {
                        labels: debtNames,
                        datasets: [{
                            label: 'Current Balance',
                            data: debtBalances,
                            backgroundColor: '#4f46e5',
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Debt Balances'
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }
        
        function showView(viewId) {
            document.querySelectorAll('.view-section').forEach(view => {
                view.style.display = 'none';
            });
            document.getElementById(viewId).style.display = 'block';

            document.querySelectorAll('.view-toggles button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${viewId}Btn`).classList.add('active');
            
            if (viewId === 'reportsView') {
                renderCharts();
            }
        }

        // --- EVENT HANDLERS ---
        
        // NEW: Event handlers for Goals
        addGoalBtn.addEventListener('click', () => {
            // Reset form
            goalNameInput.value = '';
            goalDescriptionInput.value = '';
            goalDueDateInput.value = '';
            goalAmountInput.value = '';
            showModal(goalModal);
        });

        saveGoalBtn.addEventListener('click', () => {
            const name = goalNameInput.value.trim();
            const description = goalDescriptionInput.value.trim();
            const dueDate = goalDueDateInput.value;
            const totalAmount = parseFloat(goalAmountInput.value);

            if (!name || !dueDate || isNaN(totalAmount) || totalAmount <= 0) {
                showErrorModal("Please provide a valid goal name, due date, and total amount.");
                return;
            }

            const startDate = startOfMonth(new Date());
            const endDate = parseISO(dueDate);

            if (endDate <= startDate) {
                showErrorModal("The due date must be in the future.");
                return;
            }

            const monthsBetween = differenceInCalendarMonths(endDate, startDate) + 1;
            const monthlyContribution = totalAmount / monthsBetween;

            const newGoal = {
                id: uuidv4(),
                name,
                description,
                dueDate,
                totalAmount,
                monthlyContribution
            };

            goals.push(newGoal);

            // Automatically create and assign budget categories for the goal
            for (let i = 0; i < monthsBetween; i++) {
                const monthKey = format(addMonths(startDate, i), 'yyyy-MM');
                const monthData = getMonthData(monthKey);

                // Create category if it doesn't exist
                if (!monthData.categories[name]) {
                    monthData.categories[name] = { assigned: 0, parentCategory: 'Financial Goals' };
                }
                // Set the assigned amount for the goal
                monthData.categories[name].assigned = monthlyContribution;
            }
            
            hideModal(goalModal);
            renderUI();
            saveDataToFile();
        });
        
        window.handleDeleteGoal = (goalId) => {
            if (confirm("Are you sure you want to delete this goal? This will not delete the associated category or any assigned funds.")) {
                goals = goals.filter(g => g.id !== goalId);
                renderUI();
                saveDataToFile();
            }
        };

        window.handleAssignFunds = (categoryName) => {
            let selectedCategory = categoryName; // This needs to be accessible by the click handler
            assignAvailable.textContent = formatCurrency(readyToAssign);
            
            assignMonthSelect.innerHTML = '';
            for (const monthKey in budgets) {
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = format(parseISO(monthKey + '-01'), 'MMMM yyyy');
                assignMonthSelect.appendChild(option);
            }
            
            showModal(assignModal);
            
            // Temporary assignment function to handle the click
            assignFundsBtn.onclick = () => {
                const amount = parseFloat(assignAmountInput.value);
                const assignToMonth = assignMonthSelect.value;
                if (isNaN(amount) || amount <= 0) {
                    showErrorModal('Please enter a valid amount to assign.');
                    return;
                }
                if (amount > readyToAssign) {
                    showErrorModal('You cannot assign more money than you have available.');
                    return;
                }
                if (!assignToMonth) {
                    showErrorModal('Please select a month to assign funds to.');
                    return;
                }
                const monthData = getMonthData(assignToMonth);
                if (!monthData.categories[selectedCategory]) {
                    monthData.categories[selectedCategory] = { assigned: 0, parentCategory: '' };
                }
                monthData.categories[selectedCategory].assigned += amount;
                readyToAssign -= amount;
                
                hideModal(assignModal);
                renderUI();
                saveDataToFile();
            };
        }
        
        addCategoryBtn.addEventListener('click', () => {
            const newCategoryName = newCategoryNameInput.value.trim();
            const newParentCategory = newParentCategoryInput.value.trim();
            if (newCategoryName === '') {
                showErrorModal('Category name cannot be empty.');
                return;
            }

            const allCategories = new Set();
            for (const monthKey in budgets) {
                for (const catKey in budgets[monthKey].categories) {
                    allCategories.add(catKey);
                }
            }
            if (allCategories.has(newCategoryName)) {
                 showErrorModal('A category with this name already exists.');
                 return;
            }

            const currentMonthData = getMonthData(currentMonth);
            currentMonthData.categories[newCategoryName] = { assigned: 0, parentCategory: newParentCategory, isActive: true };
            newCategoryNameInput.value = '';
            newParentCategoryInput.value = '';
            renderUI();
            saveDataToFile();
        });

        addTransactionBtn.addEventListener('click', () => {
            // No form elements to reset or hide, just opening the modal.
            transactionAmountInput.value = '';
            transactionDescriptionInput.value = '';
            transactionTypeSelect.value = 'expense';
            transactionDateInput.value = format(new Date(), 'yyyy-MM-dd');
            
            const currentMonthData = getMonthData(currentMonth);
            transactionCategorySelect.innerHTML = '<option value="">Select a Category</option>';
            const categoryOptions = Object.keys(currentMonthData.categories)
                .filter(catName => currentMonthData.categories[catName].isActive);
            categoryOptions.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                transactionCategorySelect.appendChild(option);
            });

            showModal(transactionModal);
        });
        
        function isDuplicateTransaction(transaction) {
            const monthData = getMonthData(currentMonth);
            return monthData.transactions.some(t =>
                t.date === transaction.date &&
                t.amount === transaction.amount &&
                t.description === transaction.description
            );
        }

        recordTransactionBtn.addEventListener('click', () => {
            const amount = parseFloat(transactionAmountInput.value);
            const type = transactionTypeSelect.value;
            const date = transactionDateInput.value;
            const description = transactionDescriptionInput.value;
            const category = transactionCategorySelect.value;
            
            if (isNaN(amount) || amount <= 0 || !date || !description) {
                showErrorModal('Please fill out all fields with valid data.');
                return;
            }
            if (type === 'expense' && !category) {
                showErrorModal('Please select a category for expenses.');
                return;
            }

            const month = format(parseISO(date), 'yyyy-MM');
            const monthData = getMonthData(month);

            const newTransaction = {
                id: uuidv4(),
                date,
                amount,
                description,
                type,
                category
            };

            if (isDuplicateTransaction(newTransaction)) {
                duplicateDate.textContent = newTransaction.date;
                duplicateAmount.textContent = formatCurrency(newTransaction.amount);
                duplicateDescription.textContent = newTransaction.description;
                showModal(duplicateConfirmationModal);
                
                addDuplicateAnywayBtn.onclick = () => {
                    monthData.transactions.push(newTransaction);
                    updateReadyToAssign(newTransaction);
                    hideModal(duplicateConfirmationModal);
                    hideModal(transactionModal);
                    renderUI();
                    saveDataToFile();
                };
                skipDuplicateBtn.onclick = () => {
                    hideModal(duplicateConfirmationModal);
                };
            } else {
                monthData.transactions.push(newTransaction);
                updateReadyToAssign(newTransaction);
                hideModal(transactionModal);
                renderUI();
                saveDataToFile();
            }
        });
        
        function updateReadyToAssign(transaction) {
            if (transaction.type === 'income') {
                readyToAssign += transaction.amount;
            }
        }

        window.handleEditTransaction = (transactionId) => {
            editingHistoricalTransactionId = transactionId;
            let transactionToEdit;
            let transactionMonth;
            
            for (const monthKey in budgets) {
                const monthData = budgets[monthKey];
                const foundTransaction = monthData.transactions.find(t => t.id === transactionId);
                if (foundTransaction) {
                    transactionToEdit = foundTransaction;
                    transactionMonth = monthKey;
                    break;
                }
            }
            
            if (!transactionToEdit) {
                showErrorModal('Transaction not found.');
                return;
            }
            
            editTransactionDateInput.value = transactionToEdit.date;
            editTransactionAmountInput.value = transactionToEdit.amount;
            editTransactionTypeSelect.value = transactionToEdit.type;
            editTransactionDescriptionInput.value = transactionToEdit.description;

            editTransactionCategorySelect.innerHTML = '<option value="">Select a Category</option>';
            const allCategories = new Set();
            for (const monthKey in budgets) {
                for (const catKey in budgets[monthKey].categories) {
                    allCategories.add(catKey);
                }
            }
            Array.from(allCategories).sort().forEach(categoryName => {
                const option = document.createElement('option');
                option.value = categoryName;
                option.textContent = categoryName;
                editTransactionCategorySelect.appendChild(option);
            });
            editTransactionCategorySelect.value = transactionToEdit.category || '';

            showModal(editTransactionModal);
        }

        saveEditedTransactionBtn.addEventListener('click', () => {
            const newDate = editTransactionDateInput.value;
            const newAmount = parseFloat(editTransactionAmountInput.value);
            const newType = editTransactionTypeSelect.value;
            const newDescription = editTransactionDescriptionInput.value;
            const newCategory = editTransactionCategorySelect.value;
            
            if (isNaN(newAmount) || newAmount <= 0 || !newDate || !newDescription) {
                showErrorModal('Please fill out all fields with valid data.');
                return;
            }
            if (newType === 'expense' && !newCategory) {
                showErrorModal('Please select a category for expenses.');
                return;
            }
            
            let oldTransaction;
            let oldMonth;
            for (const monthKey in budgets) {
                const monthData = budgets[monthKey];
                const transactionIndex = monthData.transactions.findIndex(t => t.id === editingHistoricalTransactionId);
                if (transactionIndex !== -1) {
                    oldTransaction = monthData.transactions[transactionIndex];
                    oldMonth = monthKey;
                    
                    const updatedTransaction = { ...oldTransaction, date: newDate, amount: newAmount, type: newType, description: newDescription, category: newCategory };
                    
                    const newMonth = format(parseISO(newDate), 'yyyy-MM');
                    if (newMonth !== oldMonth) {
                        monthData.transactions.splice(transactionIndex, 1);
                        const newMonthData = getMonthData(newMonth);
                        newMonthData.transactions.push(updatedTransaction);
                    } else {
                        monthData.transactions[transactionIndex] = updatedTransaction;
                    }
                    
                    if (oldTransaction.type === 'income') {
                         readyToAssign -= oldTransaction.amount;
                    }
                    if (newType === 'income') {
                         readyToAssign += newAmount;
                    }

                    break;
                }
            }
            
            editingHistoricalTransactionId = null;
            hideModal(editTransactionModal);
            renderUI();
            saveDataToFile();
        });

        addBulkTransactionBtn.addEventListener('click', () => {
            bulkTransactionsTextarea.value = '';
            showModal(bulkTransactionModal);
        });

        addBulkTransactionsBtnModal.addEventListener('click', () => {
            const transactionsText = bulkTransactionsTextarea.value.trim();
            if (transactionsText === '') {
                showErrorModal('Please enter transactions to add.');
                return;
            }

            const lines = transactionsText.split('\n');
            let successCount = 0;
            let errorCount = 0;

            lines.forEach(line => {
                const parts = line.split(',').map(part => part.trim());
                if (parts.length === 5) {
                    const [dateStr, amountStr, category, description, type] = parts;
                    const amount = parseFloat(amountStr);
                    const date = parseISO(dateStr);
                    
                    if (isNaN(amount) || amount <= 0 || !date || !category || !description || (type !== 'expense' && type !== 'income')) {
                        console.error(`Invalid transaction format: ${line}`);
                        errorCount++;
                        return;
                    }
                    
                    const month = format(date, 'yyyy-MM');
                    const monthData = getMonthData(month);

                    const newTransaction = { id: uuidv4(), date: dateStr, amount, description, type, category };
                    
                    if (!isDuplicateTransaction(newTransaction)) {
                        monthData.transactions.push(newTransaction);
                        updateReadyToAssign(newTransaction);
                        successCount++;
                    } else {
                        console.warn(`Skipping duplicate transaction: ${line}`);
                        errorCount++;
                    }
                } else {
                    console.error(`Invalid line format: ${line}`);
                    errorCount++;
                }
            });

            if (successCount > 0) {
                 hideModal(bulkTransactionModal);
                 renderUI();
                 saveDataToFile();
                 console.log(`Successfully added ${successCount} transactions. Skipped ${errorCount} invalid/duplicate lines.`);
            } else {
                 showErrorModal(`Failed to add any transactions. Please check the format and try again. Skipped ${errorCount} lines.`);
            }
        });
        
        addDebtBtn.addEventListener('click', () => {
            debtNameInput.value = '';
            debtOriginalBalanceInput.value = '';
            debtCurrentBalanceInput.value = '';
            debtInterestRateInput.value = '';
            debtMinPaymentInput.value = '';
            showModal(debtModal);
        });

        addDebtConfirmBtn.addEventListener('click', () => {
            const name = debtNameInput.value.trim();
            const originalBalance = parseFloat(debtOriginalBalanceInput.value);
            const currentBalance = parseFloat(debtCurrentBalanceInput.value);
            const interestRate = parseFloat(debtInterestRateInput.value);
            const minPayment = parseFloat(debtMinPaymentInput.value);

            if (!name || isNaN(originalBalance) || isNaN(currentBalance) || isNaN(interestRate) || isNaN(minPayment) || originalBalance <= 0 || currentBalance < 0) {
                showErrorModal('Please fill out all fields with valid data.');
                return;
            }

            debtList.push({ id: uuidv4(), name, originalBalance, currentBalance, interestRate, minPayment, paymentHistory: [] });

            hideModal(debtModal);
            renderUI();
            saveDataToFile();
        });
        
        window.handleRecordPayment = (debtId) => {
            selectedDebtId = debtId;
            const debt = debtList.find(d => d.id === debtId);
            if (debt) {
                paymentDebtName.textContent = debt.name;
                paymentAvailableFunds.textContent = formatCurrency(readyToAssign);
                paymentAmountInput.value = debt.minPayment;
                showModal(paymentModal);
            }
        }
        
        recordPaymentConfirmBtn.addEventListener('click', () => {
            const amount = parseFloat(paymentAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showErrorModal('Please enter a valid payment amount.');
                return;
            }

            if (amount > readyToAssign) {
                showErrorModal('You do not have enough funds to make this payment.');
                return;
            }

            const debt = debtList.find(d => d.id === selectedDebtId);
            if (debt) {
                debt.currentBalance -= amount;
                if (debt.currentBalance < 0) debt.currentBalance = 0;
                debt.paymentHistory.push({ date: format(new Date(), 'yyyy-MM-dd'), amount });
                
                const currentMonthData = getMonthData(currentMonth);
                currentMonthData.transactions.push({ id: uuidv4(), date: format(new Date(), 'yyyy-MM-dd'), amount, description: `Payment to ${debt.name}`, type: 'expense', category: 'Debt Payments' });

                readyToAssign -= amount;
                selectedDebtId = null;
                hideModal(paymentModal);
                renderUI();
                saveDataToFile();
            }
        });
        
        window.handleDeleteDebt = (debtId) => {
            if (confirm("Are you sure you want to delete this debt? This action cannot be undone.")) {
                debtList = debtList.filter(d => d.id !== debtId);
                renderUI();
                saveDataToFile();
            }
        }
        
        window.handleDeleteTransaction = (transactionId, month) => {
            if (confirm("Are you sure you want to delete this transaction?")) {
                const monthData = budgets[month];
                const transactionIndex = monthData.transactions.findIndex(t => t.id === transactionId);
                if (transactionIndex !== -1) {
                    const transaction = monthData.transactions[transactionIndex];
                    if (transaction.type === 'income') {
                        readyToAssign -= transaction.amount;
                    }
                    monthData.transactions.splice(transactionIndex, 1);
                    renderUI();
                    saveDataToFile();
                }
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            currentMonth = format(subMonths(parseISO(currentMonth + '-01'), 1), 'yyyy-MM');
            renderUI();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth = format(addMonths(parseISO(currentMonth + '-01'), 1), 'yyyy-MM');
            renderUI();
        });
        
        copyCategoriesBtn.addEventListener('click', () => {
            const nextMonth = format(addMonths(parseISO(currentMonth + '-01'), 1), 'yyyy-MM');
            const currentMonthData = getMonthData(currentMonth);
            const nextMonthData = getMonthData(nextMonth);
            
            let categoriesCopied = 0;
            for (const categoryName in currentMonthData.categories) {
                if (!nextMonthData.categories[categoryName]) {
                    const category = currentMonthData.categories[categoryName];
                    nextMonthData.categories[categoryName] = { assigned: 0, parentCategory: category.parentCategory };
                    categoriesCopied++;
                }
            }
            
            if (categoriesCopied > 0) {
                renderUI();
                saveDataToFile();
                alert(`Copied ${categoriesCopied} categories to ${format(parseISO(nextMonth + '-01'), 'MMMM yyyy')}.`);
            } else {
                alert("All categories are already present in the next month.");
            }
        });
        
        window.handleQuickBudget = (categoryName) => {
            const previousMonth = format(subMonths(parseISO(currentMonth + '-01'), 1), 'yyyy-MM');
            const previousMonthData = budgets[previousMonth];
            const currentMonthData = getMonthData(currentMonth);
            
            if (!previousMonthData || !previousMonthData.categories[categoryName]) {
                showErrorModal('No data found for this category in the previous month.');
                return;
            }
            
            const previousAssignedAmount = previousMonthData.categories[categoryName].assigned;
            const currentAssignedAmount = currentMonthData.categories[categoryName].assigned;
            const amountToAssign = previousAssignedAmount - currentAssignedAmount;
            
            if (amountToAssign <= 0) {
                showErrorModal('This category is already fully assigned or was not budgeted last month.');
                return;
            }
            
            if (readyToAssign < amountToAssign) {
                showErrorModal(`Not enough funds available to assign. You need ${formatCurrency(amountToAssign)} but only have ${formatCurrency(readyToAssign)}.`);
                return;
            }

            currentMonthData.categories[categoryName].assigned += amountToAssign;
            readyToAssign -= amountToAssign;
            
            renderUI();
            saveDataToFile();
        }

        budgetViewBtn.addEventListener('click', () => showView('budgetView'));
        reportsViewBtn.addEventListener('click', () => showView('reportsView'));
        historicalDataBtn.addEventListener('click', () => showView('historicalDataView'));

        debtSnowballBtn.addEventListener('click', () => {
            debtViewMethod = 'snowball';
            debtSnowballBtn.classList.add('active');
            debtAvalancheBtn.classList.remove('active');
            renderDebtTable();
        });
        
        debtAvalancheBtn.addEventListener('click', () => {
            debtViewMethod = 'avalanche';
            debtAvalancheBtn.classList.add('active');
            debtSnowballBtn.classList.remove('active');
            renderDebtTable();
        });

        exportDataBtn.addEventListener('click', () => {
            const dataToExport = { budgets, debtList, goals, readyToAssign };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget_data_export_${format(new Date(), 'yyyy-MM-dd')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        changeFileBtn.addEventListener('click', async () => {
            const data = await chooseNewDataFile();
            if (data) {
                budgets = data.monthlyBudgets || {};
                debtList = data.debtList || [];
                goals = data.goals || [];
                readyToAssign = data.readyToAssign || 0;
                renderUI();
                showView('budgetView');
            }
        });

        // Close modal event listeners
        closeGoalModalBtn.addEventListener('click', () => hideModal(goalModal));
        closeAssignModalBtn.addEventListener('click', () => hideModal(assignModal));
        closeTransactionModalBtn.addEventListener('click', () => hideModal(transactionModal));
        closeEditTransactionModalBtn.addEventListener('click', () => hideModal(editTransactionModal));
        closeBulkTransactionModalBtn.addEventListener('click', () => hideModal(bulkTransactionModal));
        closeDebtModalBtn.addEventListener('click', () => hideModal(debtModal));
        closePaymentModalBtn.addEventListener('click', () => hideModal(paymentModal));
        closeErrorModalBtn.addEventListener('click', () => hideModal(errorModal));

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const initApp = (data) => {
                budgets = data.monthlyBudgets || {};
                debtList = data.debtList || [];
                goals = data.goals || [];
                readyToAssign = data.readyToAssign || 0;
                loadingOverlay.style.display = 'none';
                appContainer.style.display = 'block';
                renderUI();
                showView('budgetView');
                transactionDateInput.value = format(new Date(), 'yyyy-MM-dd');
            };

            const selectExistingFile = async () => {
                try {
                    [fileHandle] = await window.showOpenFilePicker({
                        types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }],
                        multiple: false
                    });
                    const data = await readFile();
                    if (!data || typeof data !== 'object' || !('monthlyBudgets' in data)) {
                        showErrorModal('The selected file is invalid or corrupted.');
                        loadingOverlay.style.display = 'flex'; 
                        return;
                    }
                    await saveFileHandle(fileHandle);
                    initApp(data);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        showErrorModal(`File selection failed: ${err.message}`);
                    }
                    console.error('File selection or reading failed:', err);
                    loadingOverlay.style.display = 'flex'; 
                }
            };

            const createNewFile = async () => {
                try {
                    const defaultName = prompt('Enter a name for your new budget file (without extension):', 'budgetData');
                    if (!defaultName) {
                        loadingOverlay.style.display = 'flex';
                        return;
                    }

                    fileHandle = await window.showSaveFilePicker({
                        suggestedName: `${defaultName}.json`,
                        types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
                    });

                    const initialData = { monthlyBudgets: {}, debtList: [], goals: [], readyToAssign: 0 };
                    await writeFile(initialData);
                    await saveFileHandle(fileHandle);
                    initApp(initialData);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        showErrorModal(`File creation failed: ${err.message}`);
                    }
                    console.error('File creation failed:', err);
                    loadingOverlay.style.display = 'flex';
                }
            };

            document.getElementById('selectFileBtn').addEventListener('click', selectExistingFile);
            document.getElementById('createFileBtn').addEventListener('click', createNewFile);
            
            const storedHandle = await getFileHandleFromDB();
            if (storedHandle) {
                fileHandle = storedHandle;
                try {
                    const data = await readFile();
                    if (data) {
                        initApp(data);
                    } else {
                        throw new Error('Could not read data from stored file handle.');
                    }
                } catch (err) {
                    console.error('Error reading stored file handle, asking user to select new file.', err);
                    loadingOverlay.style.display = 'flex';
                }
            } else {
                loadingOverlay.style.display = 'flex';
            }
        });
    </script>
</body>
</html>
